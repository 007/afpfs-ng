<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE></TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 2.0  (Linux)">
	<META NAME="CREATED" CONTENT="20061126;13111800">
	<META NAME="CHANGEDBY" CONTENT="Alex deVries">
	<META NAME="CHANGED" CONTENT="20070211;9110800">
	<STYLE>
	<!--
		@page { size: 8.5in 11in; margin: 0.79in }
		TD P { margin-bottom: 0.08in }
		P { margin-bottom: 0.08in }
		H2 { margin-bottom: 0.08in }
		H2.western { font-family: "Luxi Sans", sans-serif; font-size: 14pt; font-style: italic }
		H2.cjk { font-family: "HG Mincho Light J"; font-size: 14pt; font-style: italic }
		H2.ctl { font-family: "Arial Unicode MS"; font-size: 14pt; font-style: italic }
		H3 { margin-bottom: 0.08in }
		H3.western { font-family: "Luxi Sans", sans-serif }
		H3.cjk { font-family: "HG Mincho Light J" }
		H3.ctl { font-family: "Arial Unicode MS" }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H1 ALIGN=CENTER>afpfs-ng 0.4</H1>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">February 11, 2007</P>
<H1>Overview</H1>
<H2 CLASS="western">Introduction</H2>
<P STYLE="margin-bottom: 0in">afpfs-ng is a userspace client
implementation for the Apple Filing Protocol (AFP) which is
traditionally used for network file sharing among Apples with Mac OS
or netatalk.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H2 CLASS="western">Why would I want afpfs-ng?</H2>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">The most common use of current afpfs-ng
is in a network that has both Apples running Mac OS X and Linux
machines. The Macs are setup as servers, and the Linux machines can
see those shares mounted locally. 
</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">In the future, afpfs-ng will also
handle the following use cases:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0in">sharing disk space from older Mac
	OS 8 and 9 servers. This means AFP 2.x support.</P>
	<LI><P STYLE="margin-bottom: 0in">extensions to graphical file
	browsers like konqueror or nautilus so they look more like the Mac
	OS finder</P>
</UL>
<H1>Getting Started</H1>
<H2 CLASS="western">Requirements</H2>
<P>To install afpfs-ng, you'll need:</P>
<UL>
	<LI><P>FUSE, the filesystem in userspace package 
	</P>
	<LI><P>libgcrypt and gmp for the crypto UAMs</P>
</UL>
<P><BR><BR>
</P>
<H2 CLASS="western">Downloading afpfs-ng</H2>
<P>You can download source or binary packages from
<A HREF="http://sourceforge.net/projects/afpfs-ng">http://sourceforge.net/projects/afpfs-ng
.</A></P>
<H2 CLASS="western">Installing afpfs-ng</H2>
<H3 CLASS="western">Installing binary packages</H3>
<P STYLE="margin-bottom: 0in">As of this release, there are only
binary packages available for FC6. This may change.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H3 CLASS="western">Compiling and installing from source</H3>
<P STYLE="margin-bottom: 0in">You need to have fuse development
libraries version 2.5.3 or later installed.</P>
<P STYLE="margin-bottom: 0in">Download afpfs-ng from the above URL.</P>
<P STYLE="margin-bottom: 0in">Build and install it with:</P>
<P STYLE="margin-bottom: 0in"><FONT FACE="Nimbus Mono L, monospace">tar
-xjf afpfs-ng-0.4.tar.bz2</FONT></P>
<P STYLE="margin-bottom: 0in"><FONT FACE="Nimbus Mono L, monospace">cd
afpfs-ng-0.4</FONT></P>
<P STYLE="margin-bottom: 0in"><FONT FACE="Nimbus Mono L, monospace">./configure</FONT></P>
<P STYLE="margin-bottom: 0in"><FONT FACE="Nimbus Mono L, monospace">make
install</FONT> 
</P>
<P STYLE="margin-bottom: 0in">This should install /usr/bin/afpfsd and
/usr/bin/afp_client.</P>
<H2 CLASS="western">Configuring an AFP server</H2>
<P STYLE="margin-bottom: 0in">If you're using netatalk as your
server, look at the documentation at http://netatalk.sf.net/.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">For Mac OS, enable sharing in the
control panel.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H2 CLASS="western">Mounting</H2>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">To do a mount, run:</P>
<P STYLE="margin-bottom: 0in">afp_client mount -u &lt;myuser&gt; -p
&lt;mypass&gt; &lt;servername&gt;:&lt;volume&gt; &lt;mountpoint&gt;</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">Here, &lt;myuser&gt; and &lt;mypass&gt;
are your login information, 
</P>
<P STYLE="margin-bottom: 0in">&lt;servername&gt; here is either the
IP address or the hostname. It isn't the name announced by Bonjour or
avahi.</P>
<P STYLE="margin-bottom: 0in">&lt;volume&gt; is the name of the
exported volume (you'll be given a list if you get it wrong)</P>
<P STYLE="margin-bottom: 0in">&lt;mountpoint&gt; is where you want to
mount it</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H2 CLASS="western">Unmounting</H2>
<P>To unmount, run:</P>
<P>afp_client unmount &lt;mountpoint&gt;</P>
<H2 CLASS="western">Other things you can do with afpfs-ng</H2>
<P><B>afp_client status</B>: this will show you details of your AFP
connection, including what's mounted, server details, authentication,
stats</P>
<P><B>afp_client suspend</B>: this will close the AFP connection, but
maintain the mount</P>
<P><B>afp_client resume</B>: this will resume a suspended connection</P>
<P><B>afp_client exit</B>: unmount everything and exit afpfsd</P>
<P><BR><BR>
</P>
<H1>Features</H1>
<H2 CLASS="western">Testing</H2>
<P STYLE="margin-bottom: 0in">afpfs-ng-0.4 has been tested to some
extent against:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0in">Mac OS 10.2.4</P>
	<LI><P STYLE="margin-bottom: 0in">Mac OS 10.3.2</P>
	<LI><P STYLE="margin-bottom: 0in">Mac OS 10.3.9</P>
	<LI><P STYLE="margin-bottom: 0in">Mac OS 10.4.2</P>
	<LI><P STYLE="margin-bottom: 0in">Netatalk 2.0.3 (see the section
	below for some restrictions)</P>
</UL>
<P STYLE="margin-bottom: 0in">It is known to fail with anything
earlier as AFP 2.x is not supported yet.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H2 CLASS="western">Compatibility</H2>
<P>afpfs-ng requires the following components: 
</P>
<UL>
	<LI><P>gmp, tested with version 4.1.4</P>
	<LI><P>libgcrypt, tested with version 1.2.3</P>
	<LI><P>fuse, tested against 2.5.3, 2.6.0, 2.6.1, 2.6.3</P>
</UL>
<P><BR><BR>
</P>
<H2 CLASS="western">Error handling and suspend/resume of connections</H2>
<P>afpfs-ng should be able to handle various network problems when
talking to a server (eg. server drops the network connection, it goes
offline, etc.</P>
<P>In these situations, the status for the server should show that
the connection is suspended.</P>
<P>To reconnect, performing some filesystem operation (eg. statfs)
should re-attempt to create the connection.  You can also force a
reconnection by using 'afp resume &lt;servername&gt;'. 
</P>
<P>This feature has not be extensively tested and will not work with
any of the crypto UAMs.</P>
<P><BR><BR>
</P>
<H2 CLASS="western">Username translation</H2>
<P>Sometimes, the numeric userids of ownership of a file will differ
between client and server, even if their names match.  
</P>
<P>If they don't match, this is called “map by name”, and
afpfs-ng detects this early in the connection setup.</P>
<P>If they do match, this is called “identical”.  This will
happen for environments that share a user directory (eg. NIS).</P>
<P>This feature is not complete.</P>
<H2 CLASS="western">Authentication</H2>
<P>Currently, the only properly supported UAMs supported are:</P>
<UL>
	<LI><P>No User Authent (aka guest)</P>
	<LI><P>Cleartxt Passwrd</P>
	<LI><P>Randnum Exchange</P>
	<LI><P>2-Way Randnum Exchange</P>
	<LI><P>DHCAST128</P>
	<LI><P>DHX2 (incomplete)</P>
</UL>
<P>By default, afpfs-ng selects the most secure method that's
supported by both the client and server (as per the spec). If you
specify the “-a 'uam method'” with the mount command, it will
force the use of this method.</P>
<P>You can see what UAM you're using by checking out the status with
'afp_client status'.</P>
<P>Volume passwords (relatively useless) work. Use “-V password”
with the mount command.</P>
<H2 CLASS="western">Some filesystem details 
</H2>
<P>The following table summarizes the situation of special files
against different servers.</P>
<TABLE WIDTH=767 BORDER=1 CELLPADDING=4 CELLSPACING=3>
	<COL WIDTH=139>
	<COL WIDTH=129>
	<COL WIDTH=84>
	<COL WIDTH=107>
	<COL WIDTH=248>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=129>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=84>
			<P>Mac OS X</P>
		</TD>
		<TD WIDTH=107>
			<P>Mac OS 7, 8, 9 (unsupported)</P>
		</TD>
		<TD WIDTH=248>
			<P>Netatalk 2.0.3</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P>Permissions</P>
		</TD>
		<TD WIDTH=129>
			<P>Read/write file permissions (eg. chmod 666 foo)</P>
		</TD>
		<TD WIDTH=84>
			<P>Yes</P>
		</TD>
		<TD WIDTH=107>
			<P>?</P>
		</TD>
		<TD WIDTH=248>
			<P>Yes, requires 'options=upriv' (See note 1)</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=129>
			<P>Execute/search file permissions (eg. chmod 111 foo)</P>
		</TD>
		<TD WIDTH=84>
			<P>Yes</P>
		</TD>
		<TD WIDTH=107>
			<P>Never</P>
		</TD>
		<TD WIDTH=248>
			<P>Yes, requires 'options=upriv' and a patch to netatalk (see
			notes 1 and 2)</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=129>
			<P>Sticky bit</P>
		</TD>
		<TD WIDTH=84>
			<P>?</P>
		</TD>
		<TD WIDTH=107>
			<P>?</P>
		</TD>
		<TD WIDTH=248>
			<P>?</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P>Symlinks</P>
		</TD>
		<TD WIDTH=129>
			<P>Creating and reading symlink from the client</P>
		</TD>
		<TD WIDTH=84>
			<P>Yes</P>
		</TD>
		<TD WIDTH=107>
			<P>?</P>
		</TD>
		<TD WIDTH=248>
			<P>Yes</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=129>
			<P>Creating a symlink on the server, then reading it from the
			client</P>
		</TD>
		<TD WIDTH=84>
			<P>Yes</P>
		</TD>
		<TD WIDTH=107>
			<P>?</P>
		</TD>
		<TD WIDTH=248>
			<P>No</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P>Aliases</P>
		</TD>
		<TD WIDTH=129>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=84>
			<P>Not yet</P>
		</TD>
		<TD WIDTH=107>
			<P>Never</P>
		</TD>
		<TD WIDTH=248>
			<P>No support in Netatalk</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P>Other special files</P>
		</TD>
		<TD WIDTH=129>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=84>
			<P>?</P>
		</TD>
		<TD WIDTH=107>
			<P>?</P>
		</TD>
		<TD WIDTH=248>
			<P>?</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=139>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=129>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=84>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=107>
			<P><BR>
			</P>
		</TD>
		<TD WIDTH=248>
			<P><BR>
			</P>
		</TD>
	</TR>
</TABLE>
<P><BR><BR>
</P>
<P>Note 1: You need to ensure that 'options:upriv' is set in the
netatalk's configuration of that volume (typically in
/etc/atalk/AppleVolumes.default).</P>
<P>Note 2: You'll need to apply a patch to netatalk in order for this
to work.  You'll find this on the afpfs-ng website, or grab the
latest netatalk from their CVS server.</P>
<H3 CLASS="western">Simple POSIX filesystem notes</H3>
<P>Most POSIX interfaces work just fine. Some notes:</P>
<UL>
	<LI><P>open() is probably broken for nonblocking IO</P>
	<LI><P>getattr() has a problem with the permissions of the mount
	point itself.</P>
	<LI><P>read() works great, and is heavily optimized for large files
	and large quantums using zero copy. Well, zero copy within afpfs-ng.</P>
	<LI><P>readlink() works fine against OS X, but netatalk appears to
	react incorrectly. I thought this was an AFP3.2 thing, but that
	appears to be incorrect as it works against 3.1.</P>
	<LI><P>symlink() works fine also against OSx. There's some magic
	with how you actually create the symlink that I discovered not from
	docs but by reading the packet traces. The magic passphrases are
	slnk (somewhat obvious) and rhap. Who knew?</P>
	<LI><P>mknod() has never been tested with special files (pipes,
	devices, etc). This probably doesn't work, and it'd be difficult
	against &lt; 10.x.</P>
	<LI><P>chmod() will never work completely against AFP &lt;3.0, and
	operates in a very odd way in netatalk. But it works on 10.x</P>
	<LI><P>utime() has second accuracy. Welcome to AFP, designed in an
	age before there were milliseconds.</P>
	<LI><P>statfs() works after considerable consternation</P>
</UL>
<H2 CLASS="western">Metadata</H2>
<H3 CLASS="western">Desktop database</H3>
<P>The structure for this sort of works, but it isn't properly tested
since this is really more appropriate for Mac OS &lt; 10.x. I read
somewhere (just once, not in an Apple document) that getcomment,
geticon, getAPPL etc are really only ever used up to 9.2.2. This
isn't quite true, when displaying icons, the filer in 10.2 first
requests the desktop icon with geticon(), and if that fails, it uses
the icon in the resource fork.</P>
<P>Comments work fine, but it is hard to really test as the only
client I have access to that'll use it is afpfs-ng. For file
&lt;dirname&gt;/&lt;filename&gt;, you'll find the comment in
&lt;dirname&gt;/.AppleDouble/comment. You can read and write to this
file to modify the comment.</P>
<P>For icons, the interface for it is in
&lt;mountpoint&gt;/.afpvolinfo/geticon, but no userspace application
has been written to be able to parse this.</P>
<P>I've never really looked at APPL, presumably it's the same thing.</P>
<P>Unless someone gives me real reason to support servers &lt; 10.x,
I'll probably just leave this alone unless my Mac OS 8 or 9 machines
will ever boot and I have nothing else to do.</P>
<H3 CLASS="western">Resource forks</H3>
<P>You can read and write the resource fork in
&lt;dirname&gt;/.AppleDouble/rsrc.</P>
<P>This isn't a parsed resource in 0.3, but is in 0.4.</P>
<H3 CLASS="western">Server icon</H3>
<P>Although of questionable value, you can see the server icon in
&lt;mountpoint&gt;/.afpvolinfo/servericon.</P>
<H1>Roadmap</H1>
<H2 CLASS="western">Summary of the top priorities of features</H2>
<P>Major features that could be added in subsequent:</P>
<UL>
	<LI><P>complete the last session failure problems under heavy load. 
	When this is fixed, afpfs-ng will get out of beta.</P>
	<LI><P>create a libafpclient.so, and make the fuse version of
	afpfs-ng use it</P>
	<LI><P>create a gnome-vfs client that uses libafpclient.so to
	support resources like filer does, but in konqueror or nautilus</P>
	<LI><P>Mac OS 7, 8 and 9 support 
	</P>
</UL>
<P><BR><BR>
</P>
<H2 CLASS="western">Supporting Apple servers before Mac OS X</H2>
<P><BR><BR>
</P>
<P>Versions of Mac OS before 2.2 were able to share files using AFP
2.1 and 2.2 over either TCP or AppleTalk (depending on the version).</P>
<P>Features that would be required getting this to work:</P>
<UL>
	<LI><P>AFP 2.x protocol handling: this has never been tried, but
	there are some obvious problems with this. In general, AFP 2.x is a
	subset of 3.2, so this should be feasible. Most obvious is any of
	the *Ext functions. I have started to look at this.</P>
	<LI><P>Other AFP 2.x features:</P>
	<UL>
		<LI><P>variable directory IDs 
		</P>
		<LI><P>chmod mode mask</P>
	</UL>
	<LI><P>userid mapping; since there's no concept of file owners in
	AFP 2.x, this'll have to be mapped to a real user</P>
	<LI><P>AppleTalk support: the Linux kernel does have support for
	AppleTalk using the socket layer, so it should be relatively simple
	to also have AT support. Development for this could be done against
	netatalk, which is probably a lot easier than having to use an older
	Mac system. In AFP 3.2, there's no longer a requirement to support
	AFP over anything but TCP.</P>
</UL>
<H3 CLASS="western">Catalog search</H3>
<P>There is currently no interface support for a remote catalog
searcher (like finder)</P>
<H3 CLASS="western">ACLs</H3>
<P>A new feature in AFP 3.2, this is in no way supported. I'm not
sure how this would interface with FUSE.</P>
<H3 CLASS="western">Current limitations:</H3>
<P STYLE="margin-bottom: 0in">For more details, have a look at
Bugs.txt.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H3 CLASS="western">Credits</H3>
<P STYLE="margin-bottom: 0in">The project was started by me, Alex
deVries &lt;<A HREF="mailto:alexthepuffin@gmail.com">alexthepuffin@gmail.com</A>&gt;.
 There's been some contributions from Derrik Pates who wrote all the
crypto UAMs and rewrote the UAM infrastructure. 
</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in">The most significant contributions
we're after is testing and documentation.</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<H1>Resources</H1>
<P STYLE="margin-bottom: 0in">Not all references are easy to find.
The useful ones are:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0in">Apple Filing Protocol Programming
	Guide, Version 3.2, 2005-06-04</P>
	<LI><P STYLE="margin-bottom: 0in">AppleTalk Filing Protocol,
	Versions 2.1 and version 2.2., Apple Computer Inc, 1999</P>
	<LI><P STYLE="margin-bottom: 0in">Inside Macintosh, Macintosh
	Toolbox Essentials, 1992</P>
	<P STYLE="margin-bottom: 0in"></P>
</UL>
<P STYLE="margin-bottom: 0in">And other software:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0in"><B>netatalk: </B>Netatalk is the
	server side, and it implements AFP 3.1 over Appletalk and TCP/IP. It
	is very well maintained.</P>
	<LI><P STYLE="margin-bottom: 0in"><B>afpfs: </B>The original afpfs
	was last release for Linux kernel 2.2.5 and was written in kernel
	space. It was written by Ben Hekster, then taken over by David
	Foster. I think it was last maintained in 1999 and only handled AFP
	2.x. Truly, afpfs-ng was intended to take over where they left off,
	but this is a complete rewrite in order to fit into FUSE.</P>
	<LI><P STYLE="margin-bottom: 0in"><B>hfsplus: </B>This might not
	seem related, but the way that hfsplus handles presenting resource
	forks to userspace may be relevant to how afpfs-ng does the same.</P>
	<LI><P STYLE="margin-bottom: 0in"><B>wireshark</B><SPAN STYLE="font-weight: medium">
	(aka ethereal): the AFP packet parsing is excellent </SPAN>
	</P>
</UL>
<P STYLE="margin-bottom: 0in"><BR>
</P>
<P STYLE="margin-bottom: 0in"><BR>
</P>
</BODY>
</HTML>